# 一念剪贴板管理器 - 测试指南

## 🎉 修复完成

已成功修复用户反馈的3个关键问题：

### ✅ 问题1：剪贴板保存后看不到数据
**修复内容**：
- 在 [AndroidManifest.xml](app/src/main/AndroidManifest.xml) 中添加了 `ClipboardListenerService` 声明
- 在 [MainActivity.kt](app/src/main/java/com/yinian/clipboard/ui/MainActivity.kt) 中添加了 Android 13+ 通知权限检查
- 服务启动前会先请求通知权限，确保服务能正常运行

### ✅ 问题2：桌面没有悬浮窗按钮
**修复内容**：
- 在 [AndroidManifest.xml](app/src/main/AndroidManifest.xml) 中添加了 `FloatingWindowService` 声明
- 创建了 [FloatingWindowPermission.kt](app/src/main/java/com/yinian/clipboard/floatingwindow/FloatingWindowPermission.kt) 扩展函数
- 修复了悬浮窗权限检查逻辑

### ✅ 问题3：设置项请求权限、悬浮窗显示不起作用
**修复内容**：
- [FloatingWindowService.kt](app/src/main/java/com/yinian/clipboard/floatingwindow/FloatingWindowService.kt) 添加了启动前权限检查
- 权限未授予时会发送广播通知 Activity
- [SettingsScreen.kt](app/src/main/java/com/yinian/clipboard/ui/screens/SettingsScreen.kt) 可以正确调用权限请求函数

---

## 🧪 测试步骤

### 1️⃣ 构建应用

在 Android Studio 中：
1. 打开项目：`project/yinian-clipboard-manager`
2. 点击 **Build > Make Project**
3. 等待构建完成

### 2️⃣ 安装到设备

1. 连接 Android 设备或启动模拟器
2. 点击 **Run > Run 'app'**
3. 等待应用安装并启动

### 3️⃣ 测试剪贴板监听功能

**测试步骤**：
1. ✅ 启动应用后，Android 13+ 设备会弹出通知权限请求对话框
2. ✅ 点击"允许"授予权限
3. ✅ 检查通知栏，应该看到"剪贴板监听服务"正在运行
4. ✅ 在任何应用中复制一段文本（如浏览器、微信等）
5. ✅ 返回一念剪贴板应用，查看主界面
6. ✅ **预期结果**：刚复制的文本应该出现在列表中

**可能的问题**：
- ❌ 如果看不到复制的文本：检查通知栏是否有服务通知
- ❌ 如果服务没有启动：检查是否授予了通知权限

### 4️⃣ 测试悬浮窗功能

**测试步骤**：
1. ✅ 打开应用，切换到"设置"标签页
2. ✅ 查看"悬浮窗权限"状态，应该显示"未授予"
3. ✅ 点击"请求权限"按钮
4. ✅ 系统会跳转到悬浮窗权限设置页面
5. ✅ 找到"一念剪贴板"应用，开启"悬浮窗权限"
6. ✅ 返回应用，权限状态应该变为"已授予"
7. ✅ 打开"悬浮窗显示"开关
8. ✅ **预期结果**：桌面应该出现一个圆形的悬浮窗按钮

**测试悬浮窗**：
1. ✅ 尝试拖动悬浮窗，应该能随意移动位置
2. ✅ 点击悬浮窗，应该看到提示"悬浮窗被点击"
3. ✅ 在设置中关闭"悬浮窗显示"开关，悬浮窗应该消失
4. ✅ 再次打开开关，悬浮窗应该重新出现

**可能的问题**：
- ❌ 如果悬浮窗不显示：检查是否授予了悬浮窗权限
- ❌ 如果无法拖动：检查是否有其他应用冲突

### 5️⃣ 测试权限处理（Android 13+）

**测试步骤**：
1. ✅ 卸载应用重新安装
2. ✅ 启动应用，应该立即弹出通知权限请求
3. ✅ 点击"拒绝"
4. ✅ **预期结果**：剪贴板监听服务不会启动，通知栏没有服务通知
5. ✅ 在系统设置中手动授予通知权限
6. ✅ 重新打开应用，服务应该自动启动

### 6️⃣ 测试完整工作流程

**完整流程测试**：
1. ✅ 启动应用，授予所有权限
2. ✅ 复制多段文本（不同应用）
3. ✅ 在主界面查看所有复制的文本
4. ✅ 测试搜索功能：输入关键词搜索
5. ✅ 测试类型筛选：切换"全部/文本/图片"
6. ✅ 测试收藏功能：点击心形图标收藏
7. ✅ 测试删除功能：点击删除按钮删除条目
8. ✅ 打开悬浮窗并拖动到合适位置
9. ✅ 切换到其他应用，复制内容
10. ✅ 点击悬浮窗，应该能快速返回应用

---

## 📊 测试清单

### 基础功能测试
- [ ] 应用能正常启动
- [ ] Android 13+ 会请求通知权限
- [ ] 授予权限后剪贴板监听服务启动
- [ ] 复制文本后自动保存到列表
- [ ] 主界面显示剪贴板列表

### 悬浮窗功能测试
- [ ] 设置界面显示权限状态
- [ ] 请求权限能跳转到系统设置
- [ ] 授予权限后状态更新为"已授予"
- [ ] 悬浮窗开关能显示/隐藏悬浮窗
- [ ] 悬浮窗能拖动
- [ ] 悬浮窗点击有响应

### 兼容性测试
- [ ] Android 13+ 设备测试通知权限
- [ ] Android 12- 设备测试（不应请求通知权限）
- [ ] 不同屏幕尺寸测试
- [ ] 不同ROM测试（小米、华为、OPPO等）

### 边界情况测试
- [ ] 拒绝权限后应用不崩溃
- [ ] 复制空内容不保存
- [ ] 复制大段文本能正常显示
- [ ] 快速连续复制只保存一次（去重）

---

## 🐛 常见问题

### Q1: 复制文本后列表为空
**可能原因**：
1. 剪贴板监听服务未启动
2. 通知权限未授予（Android 13+）

**解决方法**：
1. 检查通知栏是否有"剪贴板监听服务"通知
2. 在系统设置中授予通知权限
3. 重启应用

### Q2: 悬浮窗不显示
**可能原因**：
1. 悬浮窗权限未授予
2. FloatingWindowService 未启动

**解决方法**：
1. 在设置界面点击"请求权限"
2. 在系统设置中开启悬浮窗权限
3. 打开"悬浮窗显示"开关

### Q3: 权限请求对话框不显示
**可能原因**：
1. 权限已授予
2. Android 版本低于要求

**解决方法**：
1. 检查系统设置中应用权限状态
2. Android 13 以下不需要请求通知权限

---

## 📝 测试报告模板

测试完成后，请填写以下报告：

```
测试设备：____________________
Android 版本：________________
测试日期：____________________

✅ 通过的测试：
-
-
-

❌ 失败的测试：
-
-
-

🐛 发现的问题：
-
-
-

💡 建议和反馈：
-
-
-
```

---

## 🚀 下一步

测试通过后，可以：
1. 使用 `build.bat` 构建正式版 APK
2. 安装到日常使用的设备
3. 开始使用剪贴板管理功能
4. 根据实际使用反馈进一步优化

---

**祝测试顺利！** 🎉

如有问题，请查看代码注释或查看修复计划：[MINIMAL-FIX.md](MINIMAL-FIX.md)
