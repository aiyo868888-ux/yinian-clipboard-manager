# 调试指南 - "暂无剪贴板数据" 问题

## 问题描述
复制内容后点击悬浮窗，提示"暂无剪贴板数据"

## 已修复的问题

### 修复1: 添加 @JvmStatic 注解
**问题**: Kotlin companion object 的静态方法需要 `@JvmStatic` 注解才能被其他 Java/Kotlin 类正确调用

**修复**:
```kotlin
companion object {
    @Volatile
    private var latestClipboardData: ClipboardData? = null

    @JvmStatic
    fun getLatestClipboardData(): ClipboardData? = latestClipboardData

    @JvmStatic
    fun setLatestClipboardData(data: ClipboardData?) {
        latestClipboardData = data
    }
}
```

### 修复2: 添加详细调试日志
在 `FloatingWindowService.kt` 中添加了详细的日志输出，帮助排查问题

---

## 🔍 调试步骤

### 步骤1: 使用 Logcat 查看日志

打开 Android Studio 的 Logcat，过滤以下标签：

```bash
adb logcat | grep -E "剪贴板|clipboard|FloatingWindow"
```

### 步骤2: 执行测试流程

1. **启动应用**
   - 查看日志：应该看到 `ClipboardListenerService` 启动

2. **复制文本**
   - 查看日志：应该看到 `📋 剪贴板已缓存（未保存）: XXX`

3. **点击悬浮窗**
   - 查看日志：应该看到以下顺序
     ```
     🎯 悬浮窗被点击
     📋 获取到缓存数据: XXX
     📡 已发送保存广播
     ✅ 触发剪贴板保存: XXX
     ```

---

## 🐛 可能的问题和解决方案

### 问题1: ClipboardListenerService 未运行

**症状**:
- 复制时没有任何日志输出
- 通知栏没有"剪贴板监听服务"通知

**检查**:
```bash
adb shell dumpsys activity services | grep ClipboardListenerService
```

**解决方案**:
1. 完全关闭应用
2. 重新打开应用
3. 检查通知权限是否授予

---

### 问题2: 剪贴板监听权限未授予

**症状**:
- 日志显示权限被拒绝
- 剪贴板监听无法启动

**解决方案**:
1. Android 13+: 检查通知权限
2. 部分手机需要手动授予"读取剪贴板"权限

---

### 问题3: 静态变量跨进程访问失败

**症状**:
- 日志显示 `📋 获取到缓存数据: null`
- 但复制时有缓存的日志

**原因**: Service 运行在不同进程

**检查 AndroidManifest.xml**:
```xml
<service
    android:name=".clipboard.ClipboardListenerService"
    android:process=":remote"  <!-- 如果有这行，需要移除 -->
    ... />
```

**解决方案**: 移除 `android:process` 属性，让 Service 运行在主进程

---

### 问题4: 缓存时机问题

**症状**:
- 点击悬浮窗太快，在剪贴板监听之前

**解决方案**:
1. 复制后等待 1-2 秒
2. 查看日志确认缓存成功后再点击悬浮窗

---

## 📊 完整日志示例

### 正常流程日志:

```
D/ClipboardListenerService: onCreate: 创建剪贴板监听服务
D/ClipboardListenerService: 📋 剪贴板已缓存（未保存）: 测试文本
D/FloatingWindowService: 🎯 悬浮窗被点击
D/FloatingWindowService: 📋 获取到缓存数据: 测试文本
D/FloatingWindowService: 📡 已发送保存广播
D/ClipboardListenerService: ✅ 手动保存成功: 测试文本
```

### 异常流程日志（缓存为null）:

```
D/ClipboardListenerService: onCreate: 创建剪贴板监听服务
D/FloatingWindowService: 🎯 悬浮窗被点击
D/FloatingWindowService: 📋 获取到缓存数据: null
W/FloatingWindowService: ❌ 点击悬浮窗但无缓存数据
```

**这说明**: 复制操作没有被监听到，或者 Service 没有正确运行

---

## ✅ 修复验证清单

重新安装 APK 后，请按以下顺序测试：

- [ ] 启动应用，检查通知栏是否有"剪贴板监听服务"
- [ ] 复制文本，查看 Logcat 是否有 "📋 剪贴板已缓存" 日志
- [ ] 点击悬浮窗，查看 Logcat 完整日志流程
- [ ] 返回应用主界面，检查是否显示保存的内容

---

## 🔧 如果仍然有问题

请提供以下信息：

1. **完整 Logcat 日志**（从启动应用到点击悬浮窗）
2. **Android 版本**
3. **手机型号**
4. **是否授予了通知权限**
5. **通知栏是否显示"剪贴板监听服务"**

---

## 📝 代码变更总结

**ClipboardListenerService.kt**:
- 添加 `@Volatile` 确保线程安全
- 添加 `@JvmStatic` 使方法可被外部调用
- 添加 `setLatestClipboardData()` 方法

**FloatingWindowService.kt**:
- 添加详细的调试日志
- Toast 提示改为"暂无剪贴板数据，请先复制内容"
- 添加广播发送确认日志

---

## 🎯 下一步

1. 重新编译并安装 APK
2. 按照 [调试步骤](#-调试步骤) 进行测试
3. 提供 Logcat 日志用于进一步分析
