# å®Œæ•´æµ‹è¯•æ–¹æ¡ˆ - ç‚¹å‡»æ‚¬æµ®çª—ä¿å­˜åŠŸèƒ½

## ğŸš¨ é—®é¢˜ï¼šç‚¹å‡»æ‚¬æµ®çª—æç¤º"æš‚æ— å‰ªè´´æ¿æ•°æ®"

å¯èƒ½çš„åŸå› åˆ†æï¼š

### åŸå› 1: ClipboardListenerService æœªå¯åŠ¨
**ç—‡çŠ¶**: é€šçŸ¥æ æ²¡æœ‰"å‰ªè´´æ¿ç›‘å¬æœåŠ¡"é€šçŸ¥
**æ£€æŸ¥**: `adb shell dumpsys activity services | grep ClipboardListenerService`

### åŸå› 2: å‰ªè´´æ¿ç›‘å¬æœªè§¦å‘
**ç—‡çŠ¶**: å¤åˆ¶æ—¶æ²¡æœ‰ä»»ä½•æ—¥å¿—
**åŸå› **: Android å‰ªè´´æ¿æƒé™æˆ–ç›‘å¬å™¨æ³¨å†Œé—®é¢˜

### åŸå› 3: é™æ€å˜é‡æœªæ­£ç¡®åˆå§‹åŒ–
**ç—‡çŠ¶**: æœ‰ç¼“å­˜æ—¥å¿—ä½†è·å–ä¸ºnull
**åŸå› **: ç±»åŠ è½½æ—¶æœºé—®é¢˜

---

## ğŸ” è¯¦ç»†æ’æŸ¥æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šç¡®è®¤æœåŠ¡è¿è¡Œ

**å‘½ä»¤**:
```bash
adb shell dumpsys activity services ClipboardListenerService
```

**é¢„æœŸè¾“å‡º**: åº”è¯¥çœ‹åˆ°æœåŠ¡æ­£åœ¨è¿è¡Œ

**å¦‚æœæ²¡æœ‰è¾“å‡º**:
- æœåŠ¡æœªå¯åŠ¨
- æ£€æŸ¥ MainActivity æ˜¯å¦æ­£ç¡®å¯åŠ¨æœåŠ¡

---

### ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥å‰ªè´´æ¿ç›‘å¬

**æ‰“å¼€ Logcat** è¿‡æ»¤:
```
tag:ClipboardListenerService
```

**æ‰§è¡Œæ“ä½œ**: å¤åˆ¶ä¸€æ®µæ–‡æœ¬

**é¢„æœŸæ—¥å¿—**:
```
D/ClipboardListenerService: ğŸ“‹ å‰ªè´´æ¿å·²ç¼“å­˜ï¼ˆæœªä¿å­˜ï¼‰: XXX
```

**å¦‚æœæ²¡æœ‰æ—¥å¿—**:
1. å‰ªè´´æ¿ç›‘å¬å™¨æœªå·¥ä½œ
2. éœ€è¦é‡å¯åº”ç”¨
3. æ£€æŸ¥ AndroidManifest.xml ä¸­æœåŠ¡å£°æ˜

---

### ç¬¬ä¸‰æ­¥ï¼šæ‰‹åŠ¨è§¦å‘æµ‹è¯•

è®©æˆ‘åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–¹æ³•ï¼Œç›´æ¥åœ¨åº”ç”¨ä¸­æ·»åŠ æµ‹è¯•æŒ‰é’®ï¼š

**æ–¹æ¡ˆA**: åœ¨è®¾ç½®ç•Œé¢æ·»åŠ "æµ‹è¯•å‰ªè´´æ¿"æŒ‰é’®
**æ–¹æ¡ˆB**: ä½¿ç”¨ adb å‘½ä»¤å‘é€æµ‹è¯•å¹¿æ’­

---

## ğŸ› ï¸ å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æ”¹ä¸ºç›´æ¥ä¿å­˜ï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰

å¦‚æœé™æ€å˜é‡æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹ä¸ºç›´æ¥é€šè¿‡å¹¿æ’­ä¼ é€’æ•°æ®ï¼š

**FloatingWindowService.kt** - å‘é€å¹¿æ’­æ—¶æºå¸¦å½“å‰å‰ªè´´æ¿å†…å®¹ï¼š
```kotlin
private fun onFloatingViewClick() {
    Timber.d("ğŸ¯ æ‚¬æµ®çª—è¢«ç‚¹å‡»")

    // ç›´æ¥è·å–å½“å‰å‰ªè´´æ¿å†…å®¹
    val clipboardManager = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
    val clipData = clipboardManager.primaryClip

    if (clipData == null || clipData.itemCount == 0) {
        Toast.makeText(this, "æš‚æ— å‰ªè´´æ¿æ•°æ®ï¼Œè¯·å…ˆå¤åˆ¶å†…å®¹", Toast.LENGTH_LONG).show()
        Timber.w("âŒ å‰ªè´´æ¿ä¸ºç©º")
        return
    }

    val text = clipData.getItemAt(0).text?.toString()
    Timber.d("ğŸ“‹ å½“å‰å‰ªè´´æ¿å†…å®¹: ${text?.take(30)}")

    // å‘é€å¹¿æ’­å¹¶æºå¸¦å‰ªè´´æ¿å†…å®¹
    val saveIntent = Intent(ACTION_SAVE_CLIPBOARD).apply {
        putExtra("text", text)
        putExtra("timestamp", System.currentTimeMillis())
    }
    sendBroadcast(saveIntent)

    Toast.makeText(this, "âœ… å·²ä¿å­˜å‰ªè´´æ¿", Toast.LENGTH_SHORT).show()
    Timber.d("âœ… å·²å‘é€ä¿å­˜å¹¿æ’­")
}
```

**ClipboardListenerService.kt** - æ¥æ”¶å¹¿æ’­æ—¶ç›´æ¥ä½¿ç”¨æºå¸¦çš„æ•°æ®ï¼š
```kotlin
private fun registerSaveReceiver() {
    val receiver = object : BroadcastReceiver() {
        override fun onReceive(context: Context?, intent: Intent?) {
            if (intent?.action == FloatingWindowService.ACTION_SAVE_CLIPBOARD) {
                val text = intent.getStringExtra("text")

                if (text != null) {
                    // ç›´æ¥ä¿å­˜ï¼Œä¸ä¾èµ–ç¼“å­˜
                    val data = ClipboardData(
                        type = ClipboardDataType.TEXT,
                        textContent = text
                    )
                    saveClipboardManually(data)
                } else {
                    Timber.w("å¹¿æ’­ä¸­æ— å‰ªè´´æ¿æ•°æ®")
                }
            }
        }
    }

    val filter = IntentFilter(FloatingWindowService.ACTION_SAVE_CLIPBOARD)
    registerReceiver(receiver, filter)
}
```

---

### æ–¹æ¡ˆ2: æ·»åŠ å‰ªè´´æ¿å˜åŒ–é€šçŸ¥

åœ¨ ClipboardListenerService ä¸­æ·»åŠ æ›´æ˜æ˜¾çš„é€šçŸ¥ï¼š

```kotlin
private fun handleNewClipboardData(data: ClipboardData) {
    setLatestClipboardData(data)

    // æ·»åŠ æ˜æ˜¾çš„æ—¥å¿—
    Timber.i("========================================")
    Timber.i("ğŸ“‹ å‰ªè´´æ¿å·²ç¼“å­˜")
    Timber.i("å†…å®¹: ${data.textContent?.take(50)}")
    Timber.i("ç±»å‹: ${data.type}")
    Timber.i("========================================")
}
```

---

## âœ… æ¨èæ‰§è¡Œæ–¹æ¡ˆ

æˆ‘å»ºè®®ä½¿ç”¨**æ–¹æ¡ˆ1**ï¼ˆç›´æ¥é€šè¿‡å¹¿æ’­ä¼ é€’æ•°æ®ï¼‰ï¼Œå› ä¸ºï¼š

1. âœ… ä¸ä¾èµ–é™æ€å˜é‡ï¼Œé¿å…è·¨è¿›ç¨‹é—®é¢˜
2. âœ… æ›´ç®€å•å¯é 
3. âœ… å¯ä»¥ç›´æ¥ä¿å­˜å½“å‰å‰ªè´´æ¿å†…å®¹

---

## ğŸ¯ ç«‹å³æµ‹è¯•

### æµ‹è¯•A: ç¡®è®¤æœåŠ¡è¿è¡Œ

1. **å®‰è£…APK**
2. **å¯åŠ¨åº”ç”¨**
3. **æŸ¥çœ‹é€šçŸ¥æ ** - åº”è¯¥æœ‰"å‰ªè´´æ¿ç›‘å¬ä¸­"é€šçŸ¥
4. **å¦‚æœæ²¡æœ‰**: æœåŠ¡æœªå¯åŠ¨ï¼Œéœ€è¦ä¿®å¤ MainActivity

### æµ‹è¯•B: æ‰‹åŠ¨å‰ªè´´æ¿æµ‹è¯•

1. **å¤åˆ¶æ–‡æœ¬**: "æµ‹è¯•123"
2. **ç«‹å³ç‚¹å‡»æ‚¬æµ®çª—**
3. **æŸ¥çœ‹Toast** - åº”è¯¥æ˜¾ç¤º"âœ… å·²ä¿å­˜å‰ªè´´æ¿"æˆ–"æš‚æ— å‰ªè´´æ¿æ•°æ®"

### æµ‹è¯•C: æŸ¥çœ‹å®Œæ•´æ—¥å¿—

```bash
adb logcat -c  # æ¸…ç©ºæ—¥å¿—
# ç„¶åæ‰§è¡Œå¤åˆ¶å’Œç‚¹å‡»æ“ä½œ
adb logcat | grep -E "å‰ªè´´æ¿|clipboard|Floating"
```

---

## ğŸ“ è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯

ä¸ºäº†æ›´å¥½åœ°å¸®ä½ è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. **é€šçŸ¥æ çŠ¶æ€**:
   - [ ] æœ‰"å‰ªè´´æ¿ç›‘å¬ä¸­"é€šçŸ¥
   - [ ] æ²¡æœ‰

2. **Logcatæ—¥å¿—**ï¼ˆä»å¯åŠ¨åˆ°ç‚¹å‡»æ‚¬æµ®çª—çš„å®Œæ•´æ—¥å¿—ï¼‰

3. **Androidç‰ˆæœ¬**: __________

4. **æ‰‹æœºå‹å·**: __________

---

## ğŸ”§ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

è¯·å…ˆæ‰§è¡Œä»¥ä¸Šæµ‹è¯•æ­¥éª¤ï¼Œç„¶åå‘Šè¯‰æˆ‘ï¼š

1. é€šçŸ¥æ æ˜¯å¦æœ‰å‰ªè´´æ¿ç›‘å¬æœåŠ¡ï¼Ÿ
2. Logcat å¤åˆ¶æ—¶æ˜¯å¦æœ‰æ—¥å¿—ï¼Ÿ
3. ä½ çš„ Android ç‰ˆæœ¬å’Œæ‰‹æœºå‹å·ï¼Ÿ

è¿™æ ·æˆ‘å¯ä»¥é’ˆå¯¹æ€§åœ°å¸®ä½ è§£å†³é—®é¢˜ï¼
