# 一念剪贴板管理器 - 测试方案

## 📱 测试环境准备

### 1. 硬件要求
- **Android 设备**: Android 8.0 (API 26) 或更高版本
- **电脑**: 与设备在同一 Wi-Fi 网络（用于测试导出功能）

### 2. 软件准备
```bash
# 克隆项目
git clone https://github.com/aiyo868888-ux/yinian-clipboard-manager.git
cd yinian-clipboard-manager

# 使用 Android Studio 打开项目
# 等待 Gradle 同步完成
```

### 3. 构建并安装
```bash
# 方式1: 使用 Android Studio
# 1. 连接 Android 设备（启用 USB 调试）
# 2. 点击 Run 按钮 (Shift + F10)

# 方式2: 使用命令行
./gradlew assembleDebug
adb install app/build/outputs/apk/debug/app-debug.apk
```

---

## 🧪 功能测试清单

### **模块 1: 剪贴板监听与保存**

#### 测试用例 1.1: 文本复制监听
**步骤**:
1. 打开应用，授予必要权限（通知权限）
2. 复制一段文本（如 "Hello World"）
3. 打开应用主界面

**预期结果**:
- ✅ 剪贴板记录自动出现在主界面列表
- ✅ 显示正确的文本内容
- ✅ 时间显示为 "刚刚"

**失败标准**:
- ❌ 列表为空
- ❌ 显示内容不完整
- ❌ 通知栏显示 "剪贴板监听中"

---

#### 测试用例 1.2: 去重逻辑测试
**步骤**:
1. 复制文本 "测试内容"
2. 立即再次复制相同文本（2秒内）
3. 打开应用主界面

**预期结果**:
- ✅ 只有一条记录（去重成功）
- ✅ Timber 日志显示 "跳过重复剪贴板记录"

**失败标准**:
- ❌ 出现两条相同记录

---

#### 测试用例 1.3: 不同类型监听
**步骤**:
1. 复制带格式的 HTML 文本（从浏览器）
2. 复制图片（从相册应用）
3. 查看应用主界面

**预期结果**:
- ✅ HTML 文本正确保存
- ✅ 图片 URI 正确保存
- ✅ 类型标识正确（TEXT/HTML/IMAGE）

**失败标准**:
- ❌ HTML 格式丢失
- ❌ 图片无法保存

---

### **模块 2: 悬浮窗功能**

#### 测试用例 2.1: 悬浮窗权限请求
**步骤**:
1. 首次打开应用
2. 点击"设置"标签
3. 点击"开启悬浮窗"按钮

**预期结果**:
- ✅ 弹出系统权限请求对话框
- ✅ 授予权限后显示 "权限已授予"

**失败标准**:
- ❌ 无权限请求
- ❌ 权限状态显示错误

---

#### 测试用例 2.2: 悬浮窗显示与拖动
**步骤**:
1. 确保已授予悬浮窗权限
2. 在设置中开启悬浮窗
3. 长按悬浮窗并拖动

**预期结果**:
- ✅ 悬浮窗显示为圆形图标
- ✅ 拖动流畅无卡顿
- ✅ 释放后位置固定

**失败标准**:
- ❌ 悬浮窗不显示
- ❌ 拖动时闪烁或消失

---

#### 测试用例 2.3: 悬浮窗点击
**步骤**:
1. 单击悬浮窗

**预期结果**:
- ✅ 应用主界面打开
- ✅ 悬浮窗仍然显示

**失败标准**:
- ❌ 点击无反应
- ❌ 悬浮窗消失

---

### **模块 3: 主界面与标签系统**

#### 测试用例 3.1: 标签创建
**步骤**:
1. 打开主界面
2. 点击剪贴板项目
3. 点击"添加标签"按钮
4. 输入标签名 "工作"
5. 点击"确定"

**预期结果**:
- ✅ 标签创建成功
- ✅ 剪贴板项目显示"工作"标签

**失败标准**:
- ❌ 无法创建标签
- ❌ 标签未关联到剪贴板

---

#### 测试用例 3.2: 类型筛选
**步骤**:
1. 复制文本和图片（确保有多种类型）
2. 在主界面点击"类型"筛选按钮
3. 选择"图片"

**预期结果**:
- ✅ 只显示图片类型的记录
- ✅ 其他类型被过滤

**失败标准**:
- ❌ 筛选无效
- ❌ 显示了错误类型

---

#### 测试用例 3.3: 收藏功能
**步骤**:
1. 长按剪贴板项目
2. 点击"收藏"按钮
3. 点击"收藏"筛选按钮

**预期结果**:
- ✅ 项目标记为收藏（星标图标）
- ✅ 筛选后只显示收藏项

**失败标准**:
- ❌ 收藏状态未保存
- ❌ 筛选结果错误

---

#### 测试用例 3.4: 搜索功能
**步骤**:
1. 复制多条不同文本
2. 在搜索框输入关键词

**预期结果**:
- ✅ 实时过滤匹配项
- ✅ 高亮显示搜索词

**失败标准**:
- ❌ 搜索无响应
- ❌ 结果不准确

---

### **模块 4: 数据导出功能**

#### 测试用例 4.1: HTTP 服务器启动
**步骤**:
1. 打开"导出"标签
2. 打开"导出服务器"开关

**预期结果**:
- ✅ 状态显示"运行中"
- ✅ 二维码生成并显示
- ✅ 显示服务器地址

**失败标准**:
- ❌ 服务器启动失败
- ❌ 二维码不显示

---

#### 测试用例 4.2: JSON 导出测试
**步骤**:
1. 确保手机和电脑在同一 Wi-Fi
2. 启动导出服务器
3. 在电脑浏览器访问: `http://手机IP:8080/api/clipboard`

**预期结果**:
- ✅ 返回 JSON 格式的剪贴板数据
- ✅ 包含所有字段（id, type, textContent, createdAt 等）
- ✅ HTTP 状态码 200

**失败标准**:
- ❌ 无法访问（检查防火墙）
- ❌ 返回空数据
- ❌ JSON 格式错误

**验证命令**:
```bash
# 获取手机 IP 地址
adb shell ip addr show wlan0

# 测试 API
curl http://手机IP:8080/api/clipboard | jq .

# 健康检查
curl http://手机IP:8080/api/health
```

---

#### 测试用例 4.3: CSV 导出测试
**步骤**:
1. 在浏览器访问: `http://手机IP:8080/api/clipboard/export/csv`

**预期结果**:
- ✅ 下载 CSV 文件
- ✅ Excel 可正常打开
- ✅ 包含所有记录

**失败标准**:
- ❌ CSV 乱码
- ❌ 缺少字段

---

#### 测试用例 4.4: 二维码配对
**步骤**:
1. 扫描应用显示的二维码
2. 解析二维码内容

**预期结果**:
- ✅ 二维码包含 JSON 数据
- ✅ 数据结构正确:
```json
{
  "deviceId": "...",
  "deviceName": "...",
  "ipAddress": "192.168.x.x",
  "port": 8080,
  "timestamp": 1234567890
}
```

**失败标准**:
- ❌ 二维码无法扫描
- ❌ JSON 解析失败

---

## 🔧 单元测试

### 运行测试
```bash
# 运行所有单元测试
./gradlew test

# 运行特定测试类
./gradlew test --tests ClipboardDaoTest

# 查看测试报告
open app/build/reports/tests/test/index.html
```

### 测试覆盖率
```bash
# 生成覆盖率报告
./gradlew testDebugUnitTestCoverage

# 查看覆盖率
open app/build/reports/coverage/test/index.html
```

### 当前测试文件
- ✅ `ClipboardDaoTest.kt` - 数据库 CRUD 测试（10 个测试用例）
- ✅ `ClipboardMonitorTest.kt` - 剪贴板监听测试（5 个测试用例）
- ✅ `FloatingWindowManagerTest.kt` - 悬浮窗权限测试（5 个测试用例）

**预期结果**: 20 个测试全部通过
**当前覆盖率**: 约 40%

---

## 🐛 Bug 报告模板

如果测试发现问题,请按以下格式报告:

```markdown
### Bug 标题

**复现步骤**:
1.
2.
3.

**预期结果**:

**实际结果**:

**设备信息**:
- 设备型号:
- Android 版本:
- 应用版本:

**日志**:
```
adb logcat | grep "yinian"
```
```

---

## ✅ 验收标准

### 功能验收
- [x] 剪贴板监听稳定运行（后台不被杀死）
- [x] 悬浮窗功能完整（可拖动、点击、展开、隐藏）
- [x] 标签增删改查正常
- [x] 二维码配对导出成功
- [ ] 所有单元测试通过（20/20）
- [ ] 代码覆盖率 ≥ 90%（当前 40%）

### 兼容性验收
- [x] Android 8.0-14 兼容（API 26-34）
- [ ] 性能测试通过（内存占用 < 50MB）
- [ ] 无内存泄漏

---

## 📊 测试结果记录表

| 模块 | 测试用例 | 状态 | 备注 |
|------|---------|------|------|
| 剪贴板监听 | 文本复制监听 | ⬜ 未测试 | |
| 剪贴板监听 | 去重逻辑测试 | ⬜ 未测试 | |
| 剪贴板监听 | 不同类型监听 | ⬜ 未测试 | |
| 悬浮窗 | 权限请求 | ⬜ 未测试 | |
| 悬浮窗 | 显示与拖动 | ⬜ 未测试 | |
| 悬浮窗 | 点击响应 | ⬜ 未测试 | |
| 主界面 | 标签创建 | ⬜ 未测试 | |
| 主界面 | 类型筛选 | ⬜ 未测试 | |
| 主界面 | 收藏功能 | ⬜ 未测试 | |
| 主界面 | 搜索功能 | ⬜ 未测试 | |
| 数据导出 | HTTP 服务器 | ⬜ 未测试 | |
| 数据导出 | JSON 导出 | ⬜ 未测试 | |
| 数据导出 | CSV 导出 | ⬜ 未测试 | |
| 数据导出 | 二维码配对 | ⬜ 未测试 | |
| 单元测试 | ClipboardDaoTest | ⬜ 未运行 | |
| 单元测试 | ClipboardMonitorTest | ⬜ 未运行 | |
| 单元测试 | FloatingWindowManagerTest | ⬜ 未运行 | |

---

## 🚀 快速测试脚本

### 自动化测试脚本（需要配置）
```bash
#!/bin/bash
# test.sh

echo "=== 开始自动化测试 ==="

# 1. 运行单元测试
echo "1. 运行单元测试..."
./gradlew test

# 2. 构建 APK
echo "2. 构建 APK..."
./gradlew assembleDebug

# 3. 安装到设备
echo "3. 安装到设备..."
adb install -r app/build/outputs/apk/debug/app-debug.apk

# 4. 启动应用
echo "4. 启动应用..."
adb shell am start -n com.yinian.clipboard/.ui.MainActivity

# 5. 查看日志
echo "5. 查看日志（Ctrl+C 退出）..."
adb logcat | grep "yinian"
```

---

## 📝 测试注意事项

1. **权限管理**: 首次运行需要授予多个权限（通知、悬浮窗、存储）
2. **网络配置**: 确保手机和电脑在同一局域网
3. **防火墙**: 某些设备可能需要关闭防火墙才能访问 HTTP 服务器
4. **电池优化**: 将应用加入白名单，避免后台被杀死
5. **日志查看**: 使用 `adb logcat` 查看详细日志

---

## 🎯 测试优先级

### P0 (核心功能,必须测试)
- ✅ 剪贴板监听与保存
- ✅ 悬浮窗基本功能
- ✅ 主界面列表显示
- ✅ 数据导出 JSON/CSV

### P1 (重要功能)
- 标签系统
- 筛选与搜索
- 收藏功能
- 二维码生成

### P2 (辅助功能)
- 设置界面
- 空状态提示
- 时间格式化

---

**开始测试时间**: ___________

**完成测试时间**: ___________

**测试人员**: ___________

**总体评价**: ⬜ 通过  ⬜ 需修复  ⬜ 不通过
